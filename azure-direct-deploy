#!/bin/bash

# TradingQ Azure Direct Deployment

# This script creates the project structure directly in Azure Cloud Shell

set -e

echo â€œâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â€
echo â€œâ•‘   TradingQ Direct Azure Deployment (No Archive Needed)    â•‘â€
echo â€œâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â€
echo â€œâ€

GREEN=â€™\033[0;32mâ€™
BLUE=â€™\033[0;34mâ€™
YELLOW=â€™\033[1;33mâ€™
NC=â€™\033[0mâ€™

print_status() { echo -e â€œ${BLUE}[INFO]${NC} $1â€; }
print_success() { echo -e â€œ${GREEN}[âœ“]${NC} $1â€; }

# Configuration

RG=${RG:-rg-tradingq-quant}
LOC=${LOC:-eastus}
ACR_NAME=acrtradingq$RANDOM
ENV=cae-tradingq-quant

print_status â€œThis script will deploy TradingQ to Azure Container Appsâ€
print_status â€œConfiguration: Resource Group=$RG, Location=$LOCâ€
echo â€œâ€
read -p â€œContinue? (y/n) â€œ -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
exit 1
fi

# Create project structure

print_status â€œCreating project structureâ€¦â€
mkdir -p tradingq-deploy/{services/{api/app,worker/worker},apps/web-dashboard/app,infra}

# Create API files

print_status â€œCreating API serviceâ€¦â€
cat > tradingq-deploy/services/api/app/main.py << â€˜EOFâ€™
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
import redis.asyncio as redis
import json
import os
from typing import Set
import asyncio

app = FastAPI(title=â€œTradingQ APIâ€, version=â€œ1.0.0â€)

origins = json.loads(os.getenv(â€œAPI_CORS_ORIGINSâ€, â€˜[â€*â€]â€™))
app.add_middleware(CORSMiddleware, allow_origins=origins, allow_credentials=True, allow_methods=[â€*â€], allow_headers=[â€*â€])

REDIS_URL = os.getenv(â€œREDIS_URLâ€, â€œredis://localhost:6379/0â€)
WS_BROADCAST_CHANNEL = os.getenv(â€œWS_BROADCAST_CHANNELâ€, â€œticksâ€)
active_connections: Set[WebSocket] = set()
redis_client = None

async def get_redis():
global redis_client
if redis_client is None:
redis_client = await redis.from_url(REDIS_URL, decode_responses=True)
return redis_client

@app.on_event(â€œstartupâ€)
async def startup_event():
await get_redis()
print(fâ€âœ… Connected to Redis at {REDIS_URL}â€)

@app.on_event(â€œshutdownâ€)
async def shutdown_event():
global redis_client
if redis_client:
await redis_client.close()

@app.get(â€/â€)
async def root():
return {â€œserviceâ€: â€œTradingQ APIâ€, â€œversionâ€: â€œ1.0.0â€, â€œstatusâ€: â€œrunningâ€}

@app.get(â€/healthâ€)
async def health_check():
try:
r = await get_redis()
await r.ping()
return {â€œstatusâ€: â€œhealthyâ€, â€œredisâ€: â€œconnectedâ€, â€œwebsocket_connectionsâ€: len(active_connections)}
except Exception as e:
return {â€œstatusâ€: â€œunhealthyâ€, â€œredisâ€: â€œdisconnectedâ€, â€œerrorâ€: str(e)}

async def broadcast_from_redis():
r = await get_redis()
pubsub = r.pubsub()
await pubsub.subscribe(WS_BROADCAST_CHANNEL)
print(fâ€ğŸ§ Listening to Redis channel: {WS_BROADCAST_CHANNEL}â€)
try:
async for message in pubsub.listen():
if message[â€œtypeâ€] == â€œmessageâ€:
data = message[â€œdataâ€]
disconnected = set()
for connection in active_connections:
try:
await connection.send_text(data)
except:
disconnected.add(connection)
active_connections.difference_update(disconnected)
except Exception as e:
print(fâ€âŒ Redis error: {e}â€)
finally:
await pubsub.unsubscribe(WS_BROADCAST_CHANNEL)

@app.websocket(â€/wsâ€)
async def websocket_endpoint(websocket: WebSocket):
await websocket.accept()
active_connections.add(websocket)
print(fâ€ğŸ”Œ WebSocket connected. Total: {len(active_connections)}â€)
if len(active_connections) == 1:
asyncio.create_task(broadcast_from_redis())
try:
while True:
data = await websocket.receive_text()
await websocket.send_json({â€œtypeâ€: â€œackâ€, â€œmessageâ€: â€œReceivedâ€, â€œdataâ€: data})
except WebSocketDisconnect:
active_connections.remove(websocket)
print(fâ€ğŸ”Œ WebSocket disconnected. Total: {len(active_connections)}â€)
except Exception as e:
if websocket in active_connections:
active_connections.remove(websocket)

@app.get(â€/api/statsâ€)
async def get_stats():
return {â€œactive_connectionsâ€: len(active_connections), â€œbroadcast_channelâ€: WS_BROADCAST_CHANNEL}
EOF

cat > tradingq-deploy/services/api/requirements.txt << â€˜EOFâ€™
fastapi==0.109.0
uvicorn[standard]==0.27.0
redis==5.0.1
python-dotenv==1.0.0
websockets==12.0
pydantic==2.5.3
EOF

cat > tradingq-deploy/services/api/Dockerfile << â€˜EOFâ€™
FROM python:3.11-slim
WORKDIR /app
COPY services/api/requirements.txt .
RUN pip install â€“no-cache-dir -r requirements.txt
COPY services/api/app ./app
EXPOSE 8000
CMD [â€œuvicornâ€, â€œapp.main:appâ€, â€œâ€“hostâ€, â€œ0.0.0.0â€, â€œâ€“portâ€, â€œ8000â€]
EOF

# Create Worker files

print_status â€œCreating Worker serviceâ€¦â€
cat > tradingq-deploy/services/worker/worker/main.py << â€˜EOFâ€™
import asyncio
import ccxt.async_support as ccxt
import redis.asyncio as redis
import json
import os
from datetime import datetime

REDIS_URL = os.getenv(â€œREDIS_URLâ€, â€œredis://localhost:6379/0â€)
WS_BROADCAST_CHANNEL = os.getenv(â€œWS_BROADCAST_CHANNELâ€, â€œticksâ€)
EXCHANGE_ID = os.getenv(â€œEXCHANGE_IDâ€, â€œcoinbaseâ€)
SYMBOL = os.getenv(â€œSYMBOLâ€, â€œBTC/USDâ€)
TIMEFRAME = os.getenv(â€œTIMEFRAMEâ€, â€œ1mâ€)
SMA_PERIOD = int(os.getenv(â€œSMA_PERIODâ€, â€œ20â€))

price_history = []
redis_client = None
exchange = None

async def get_redis():
global redis_client
if redis_client is None:
redis_client = await redis.from_url(REDIS_URL, decode_responses=True)
return redis_client

async def get_exchange():
global exchange
if exchange is None:
exchange_class = getattr(ccxt, EXCHANGE_ID)
exchange = exchange_class({â€˜enableRateLimitâ€™: True})
return exchange

def calculate_sma(prices, period):
if len(prices) < period:
return None
return sum(prices[-period:]) / period

async def main_loop():
global price_history
print(fâ€ğŸš€ TradingQ Worker Startedâ€)
print(fâ€ğŸ“¡ Exchange: {EXCHANGE_ID} | Symbol: {SYMBOL} | Timeframe: {TIMEFRAME}â€)

```
timeframe_seconds = {'1m': 60, '5m': 300, '15m': 900, '1h': 3600}
interval = timeframe_seconds.get(TIMEFRAME, 60)

try:
    while True:
        try:
            ex = await get_exchange()
            ticker = await ex.fetch_ticker(SYMBOL)
            price = ticker['last']
            price_history.append(price)
            if len(price_history) > 100:
                price_history = price_history[-100:]
            
            sma = calculate_sma(price_history, SMA_PERIOD)
            signal = None
            if sma:
                signal = "BUY" if price > sma else "SELL" if price < sma else "HOLD"
            
            tick_data = {
                "timestamp": datetime.utcnow().isoformat(),
                "exchange": EXCHANGE_ID,
                "symbol": SYMBOL,
                "price": price,
                "bid": ticker.get('bid'),
                "ask": ticker.get('ask'),
                "volume": ticker.get('volume'),
                "sma": sma,
                "signal": signal,
                "history_size": len(price_history)
            }
            
            r = await get_redis()
            await r.publish(WS_BROADCAST_CHANNEL, json.dumps(tick_data))
            print(f"ğŸ“Š {SYMBOL} @ ${price:.2f} | SMA: {sma:.2f if sma else 'N/A'} | {signal}")
        except Exception as e:
            print(f"âŒ Error: {e}")
        
        await asyncio.sleep(interval)
except KeyboardInterrupt:
    print("\nğŸ‘‹ Shutting down...")
finally:
    if exchange:
        await exchange.close()
    if redis_client:
        await redis_client.close()
```

if **name** == â€œ**main**â€:
asyncio.run(main_loop())
EOF

cat > tradingq-deploy/services/worker/requirements.txt << â€˜EOFâ€™
ccxt==4.2.25
redis==5.0.1
python-dotenv==1.0.0
EOF

cat > tradingq-deploy/services/worker/Dockerfile << â€˜EOFâ€™
FROM python:3.11-slim
WORKDIR /app
COPY services/worker/requirements.txt .
RUN pip install â€“no-cache-dir -r requirements.txt
COPY services/worker/worker ./worker
CMD [â€œpythonâ€, â€œ-mâ€, â€œworker.mainâ€]
EOF

print_success â€œProject structure created!â€

# Deploy to Azure

print_status â€œStarting Azure deploymentâ€¦â€

print_status â€œCreating Resource Groupâ€¦â€
az group create -n $RG -l $LOC

print_status â€œCreating Container Registryâ€¦â€
az acr create -n $ACR_NAME -g $RG â€“sku Basic â€“admin-enabled true
az acr login -n $ACR_NAME
ACR_LOGIN=$(az acr show -n $ACR_NAME -g $RG â€“query loginServer -o tsv)

print_status â€œBuilding imagesâ€¦ (this takes 5-10 minutes)â€
cd tradingq-deploy

az acr build -r $ACR_NAME -t tradingq-api:1.0 -f services/api/Dockerfile . &
PID_API=$!
az acr build -r $ACR_NAME -t tradingq-worker:1.0 -f services/worker/Dockerfile . &
PID_WORKER=$!

wait $PID_API
wait $PID_WORKER

print_success â€œImages built!â€

print_status â€œCreating Container Apps Environmentâ€¦â€
az extension add â€“name containerapp â€“upgrade 2>/dev/null || true
az containerapp env create -n $ENV -g $RG -l $LOC

print_status â€œDeploying Redisâ€¦â€
az containerapp create -n redis -g $RG â€“environment $ENV   
â€“image redis:7-alpine â€“ingress internal â€“target-port 6379   
â€“cpu 0.5 â€“memory 1.0Gi

print_status â€œDeploying APIâ€¦â€
az containerapp create -n api -g $RG â€“environment $ENV   
â€“image $ACR_LOGIN/tradingq-api:1.0 â€“registry-server $ACR_LOGIN   
â€“ingress external â€“target-port 8000 â€“cpu 0.5 â€“memory 1.0Gi   
â€“env-vars REDIS_URL=redis://redis:6379/0 WS_BROADCAST_CHANNEL=ticks API_CORS_ORIGINS=â€™[â€*â€]â€™

API_FQDN=$(az containerapp show -n api -g $RG â€“query properties.configuration.ingress.fqdn -o tsv)

print_status â€œDeploying Workerâ€¦â€
az containerapp create -n worker -g $RG â€“environment $ENV   
â€“image $ACR_LOGIN/tradingq-worker:1.0 â€“registry-server $ACR_LOGIN   
â€“cpu 0.5 â€“memory 1.0Gi   
â€“env-vars REDIS_URL=redis://redis:6379/0 WS_BROADCAST_CHANNEL=ticks   
EXCHANGE_ID=coinbase SYMBOL=BTC/USD TIMEFRAME=1m SMA_PERIOD=20

echo â€œâ€
echo â€œâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—â€
echo â€œâ•‘              Deployment Complete! ğŸ‰                       â•‘â€
echo â€œâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â€
echo â€œâ€
echo â€œğŸ“Š Your TradingQ API is live at:â€
echo â€œ   ğŸ”— https://$API_FQDNâ€
echo â€œ   ğŸ“Š Health: https://$API_FQDN/healthâ€
echo â€œ   ğŸ“– Docs: https://$API_FQDN/docsâ€
echo â€œ   ğŸ”Œ WebSocket: wss://$API_FQDN/wsâ€
echo â€œâ€
echo â€œğŸ“ View Worker logs:â€
echo â€œ   az containerapp logs show -n worker -g $RG â€“followâ€
echo â€œâ€
print_success â€œAll services deployed!â€
